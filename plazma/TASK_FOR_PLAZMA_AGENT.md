# Техническое задание для Plazma агента

## Цель
Настроить интеграцию между проектом Plazma и внешним сервисом Vital для отображения товаров из каталога Plazma в секции "Рекомендуем" на странице Vital.

## Что уже сделано

### 1. Создан внешний API роутер
- **Файл:** `src/api/external.ts`
- **Функционал:**
  - Аутентификация по API ключу (`X-API-Key` header)
  - Эндпоинты для получения каталога, категорий, товаров
  - Эндпоинт для создания заказов
  - Валидация данных и обработка ошибок

### 2. Настроен Prisma клиент
- **Файл:** `src/lib/prisma.ts`
- Подключение к MongoDB через Prisma ORM

### 3. Добавлена переменная окружения
- **Файл:** `src/config/env.ts`
- Поддержка `EXTERNAL_API_KEY` для аутентификации

### 4. Роутер подключен к серверу
- **Файл:** `src/server.ts`
- Добавлен маршрут `/api/external/*`

### 5. Улучшена обработка ошибок
- В Vital frontend добавлена обработка ошибок при запросах к API

### 6. Все изменения в git
- **Коммит:** `396ff99`
- Все файлы закоммичены и готовы к деплою

## Что нужно сделать

### Шаг 1: Добавить переменную EXTERNAL_API_KEY в Railway

1. Откройте проект **Plazma** на Railway: https://railway.app
2. Перейдите в настройки проекта (Settings)
3. Найдите раздел "Variables" или "Environment Variables"
4. Добавьте новую переменную:
   - **Имя:** `EXTERNAL_API_KEY`
   - **Значение:** `838167d1702e25d4d0c97a5db2ccc25727c2342bf025f08858e19b0388ffc0de`
5. Сохраните изменения

**Время:** ~3 минуты

### Шаг 2: Проверить/добавить переменные в Vital

1. Откройте проект **Vital** на Railway
2. Перейдите в настройки проекта (Settings)
3. Проверьте наличие следующих переменных:

   **PLAZMA_API_KEY**
   - Должен совпадать с `EXTERNAL_API_KEY` из проекта Plazma
   - Значение: `838167d1702e25d4d0c97a5db2ccc25727c2342bf025f08858e19b0388ffc0de`

   **PLAZMA_API_URL**
   - URL API Plazma
   - Значение: `https://plazma-production.up.railway.app/api/external`

4. Если переменных нет — добавьте их
5. Сохраните изменения

**Время:** ~5 минут

### Шаг 3: Перезапустить проект Plazma

1. В проекте Plazma на Railway
2. Перейдите в раздел "Deployments"
3. Нажмите "Redeploy" или "Restart"
4. Дождитесь завершения деплоя (обычно 2-3 минуты)

**Время:** ~3 минуты

### Шаг 4: Проверить работу API

1. Откройте терминал
2. Выполните тестовый запрос:

```bash
curl -X GET "https://plazma-production.up.railway.app/api/external/catalog" \
  -H "X-API-Key: 838167d1702e25d4d0c97a5db2ccc25727c2342bf025f08858e19b0388ffc0de"
```

3. Должен вернуться JSON с каталогом товаров
4. Если ошибка 401 — проверьте переменную `EXTERNAL_API_KEY` в Railway

**Время:** ~2 минуты

### Шаг 5: Проверить отображение на Vital

1. Откройте страницу Vital: https://vital-production-82b0.up.railway.app/webapp
2. Найдите секцию "Рекомендуем"
3. Должны отображаться товары из каталога Plazma
4. Если товары не отображаются:
   - Проверьте консоль браузера (F12) на наличие ошибок
   - Проверьте переменные `PLAZMA_API_KEY` и `PLAZMA_API_URL` в проекте Vital
   - Убедитесь, что проект Vital перезапущен после добавления переменных

**Время:** ~5 минут

## Пошаговая инструкция

### Детальная инструкция для Railway

#### Для проекта Plazma:

1. Войдите в Railway: https://railway.app
2. Выберите проект **Plazma**
3. В левом меню выберите **Variables**
4. Нажмите **+ New Variable**
5. Заполните:
   - **Key:** `EXTERNAL_API_KEY`
   - **Value:** `838167d1702e25d4d0c97a5db2ccc25727c2342bf025f08858e19b0388ffc0de`
6. Нажмите **Add**
7. Перейдите в **Deployments**
8. Нажмите **Redeploy** (если автоматический деплой не запустился)

#### Для проекта Vital:

1. Выберите проект **Vital**
2. В левом меню выберите **Variables**
3. Проверьте/добавьте переменные:

   **Переменная 1:**
   - **Key:** `PLAZMA_API_KEY`
   - **Value:** `838167d1702e25d4d0c97a5db2ccc25727c2342bf025f08858e19b0388ffc0de`

   **Переменная 2:**
   - **Key:** `PLAZMA_API_URL`
   - **Value:** `https://plazma-production.up.railway.app/api/external`

4. Сохраните изменения
5. Перезапустите проект (если нужно)

## Решение проблем

### Проблема: API возвращает 401 Unauthorized

**Причина:** Неверный или отсутствующий API ключ

**Решение:**
1. Проверьте, что переменная `EXTERNAL_API_KEY` добавлена в проект Plazma
2. Убедитесь, что значение ключа совпадает с тем, что используется в запросах
3. Перезапустите проект Plazma после добавления переменной

### Проблема: Товары не отображаются на Vital

**Причина 1:** Неверные переменные в проекте Vital

**Решение:**
1. Проверьте `PLAZMA_API_KEY` — должен совпадать с `EXTERNAL_API_KEY` из Plazma
2. Проверьте `PLAZMA_API_URL` — должен быть `https://plazma-production.up.railway.app/api/external`
3. Перезапустите проект Vital

**Причина 2:** Ошибки в консоли браузера

**Решение:**
1. Откройте консоль браузера (F12)
2. Проверьте ошибки в Network tab
3. Убедитесь, что запросы к API идут с правильным заголовком `X-API-Key`

**Причина 3:** CORS ошибки

**Решение:**
- CORS уже настроен в `src/server.ts` для всех источников
- Если проблема сохраняется, проверьте настройки CORS в коде

### Проблема: API возвращает 500 Internal Server Error

**Причина:** Ошибка на сервере

**Решение:**
1. Проверьте логи проекта Plazma в Railway
2. Убедитесь, что база данных подключена
3. Проверьте, что все зависимости установлены

### Проблема: Деплой не запускается

**Причина:** Ошибки компиляции или сборки

**Решение:**
1. Проверьте логи сборки в Railway
2. Убедитесь, что все файлы закоммичены в git
3. Проверьте, что `npm run build` выполняется успешно локально

## Критерии успеха

✅ Переменная `EXTERNAL_API_KEY` добавлена в проект Plazma на Railway  
✅ Переменные `PLAZMA_API_KEY` и `PLAZMA_API_URL` добавлены в проект Vital  
✅ Проект Plazma успешно перезапущен  
✅ Тестовый запрос к API возвращает каталог товаров (не 401)  
✅ Товары из Plazma отображаются в секции "Рекомендуем" на странице Vital  
✅ Нет ошибок в консоли браузера  

## Дополнительная информация

### API эндпоинты

- **GET** `/api/external/catalog` — полный каталог (категории + товары)
- **GET** `/api/external/categories` — список категорий
- **GET** `/api/external/products` — список товаров (с фильтрацией)
- **GET** `/api/external/products/:id` — конкретный товар
- **POST** `/api/external/orders` — создать заказ

### Документация API

Полная документация находится в файле: `docs/EXTERNAL_API.md`

### Секретный ключ

**Важно:** Сохраните этот ключ в безопасном месте. Если ключ будет скомпрометирован, сгенерируйте новый.

Текущий ключ: `838167d1702e25d4d0c97a5db2ccc25727c2342bf025f08858e19b0388ffc0de`

### Ссылки

- Plazma API: https://plazma-production.up.railway.app/api/external
- Vital Webapp: https://vital-production-82b0.up.railway.app/webapp
- Railway Dashboard: https://railway.app

## Время выполнения

**Общее время:** ~15-20 минут

- Шаг 1 (Railway Plazma): ~3 минуты
- Шаг 2 (Railway Vital): ~5 минут
- Шаг 3 (Перезапуск): ~3 минуты
- Шаг 4 (Тестирование API): ~2 минуты
- Шаг 5 (Проверка Vital): ~5 минут

## Контакты

При возникновении проблем проверьте:
1. Логи проектов в Railway
2. Консоль браузера (F12)
3. Документацию API: `docs/EXTERNAL_API.md`

