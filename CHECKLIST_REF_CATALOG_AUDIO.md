# Чеклист: реф-ссылки, каталог, аудио-подарок

Документ описывает, **что сделано** при рефакторинге и **что нужно настроить**, чтобы работали реферальные ссылки, каталог и раздел «Подарок» (звуковые матрицы).

---

## 1. Реферальные ссылки (реф-ссылки)

### Что сделано

- **Исправлен баг в `buildReferralLink`:** раньше при наличии у пользователя Telegram username в ссылку подставлялся `?start=username` вместо кода реферала (`ref_direct_PWXXX`), из-за чего переход по ссылке не засчитывался. Теперь **всегда** возвращается ссылка вида `https://t.me/BOT_USERNAME?start=ref_direct_КОД` (или `ref_multi_КОД`).
- Обработчик кнопки «Ваша реф ссылка» (`nav:my_ref_link`) обёрнут в `try/catch`: при ошибке в лог пишется причина, пользователю — сообщение с подсказкой про BOT_USERNAME и БД.

### Что нужно для работы

| Переменная / условие | Где задать | Описание |
|----------------------|------------|----------|
| **BOT_USERNAME** | Railway → Variables (или `.env`) | Имя бота **без** `@`, точно как в @BotFather (например `PLAZMA_test8_bot`). Иначе ссылка ведёт на другого бота. |
| **DATABASE_URL** | Railway → Variables (или `.env`) | Строка подключения к MongoDB (Railway или другая). Без неё не создаётся `PartnerProfile` и не выдаётся ссылка. |
| **ADMIN_CHAT_ID** | Не обязательно для реф-ссылок | Нужен только для админ-функций. На реф-ссылки не влияет. |

**Проверка:** нажать в боте «Ваша реф ссылка» — должна прийти ссылка вида `https://t.me/ВАШ_БОТ?start=ref_direct_PWXXXXXX`. Переход по ней и нажатие «Start» должен записать реферала в БД (логи «Referral: …»).

---

## 2. Каталог (товары в мини-приложении)

### Что сделано

- В каталог выводятся **все активные товары** (`isActive: true`), без обязательного поля `imageUrl`; товары без картинки отображаются с заглушкой.
- В `getActiveCategories()` добавлена обработка ошибок БД (при проблемах с подключением возвращается пустой массив, как и для товаров).
- API: `/webapp/api/products`, `/webapp/api/categories`, `/webapp/api/categories/:id/products` — данные берутся из той же БД, что и `DATABASE_URL`.

### Что нужно для работы

| Переменная / условие | Где задать | Описание |
|----------------------|------------|----------|
| **DATABASE_URL** | Railway / `.env` | Та же БД, что и для бота. В ней должны быть коллекции **Category** и **Product** с `isActive: true`. |
| Данные в БД | Скрипты или админка | Если каталог пустой — нужны категории и товары. Варианты: 1) перенос из другой MongoDB: `SOURCE_MONGO_URL="..." node scripts/sync-from-mongodb.js`; 2) восстановление из бэкапа: `node scripts/restore-from-cloudinary.js путь/к/файлу.json`; 3) добавление товаров через админ-панель. |

**Проверка:** открыть мини-приложение (кнопка «Открыть каталог» / «Каталог по плазменному здоровью») — на главной должны отображаться категории и товары (или сообщение «Каталог пока пуст», если в БД пусто).

---

## 3. Аудио-подарок (звуковые матрицы Гаряева)

### Что сделано

- Раздел «Подарок»: кнопка «Слушать звуковые матрицы» вызывает `showAudioFiles(ctx, 'gift')`. Список берётся из БД (модель **AudioFile**, категория `gift`) или, если в БД пусто и настроен Cloudinary, — из папки **CLOUDINARY_AUDIO_FOLDER**.
- Загрузка аудио: только **админы** (по `ADMIN_CHAT_ID`) могут отправлять боту аудиофайл — создаётся запись в БД и файл появляется в разделе «Звуковые матрицы».
- Идемпотентность: повторная отправка того же файла (тот же `file_id`) не создаёт дубликат, бот отвечает «Этот аудиофайл уже в каталоге».
- Логирование ошибок при загрузке: в логах сервера выводятся `message`, `code` ошибки для диагностики.

### Что нужно для работы

| Переменная / условие | Где задать | Описание |
|----------------------|------------|----------|
| **ADMIN_CHAT_ID** | Railway / `.env` | Telegram ID администратора (или несколько через запятую). Только эти пользователи могут загружать аудио. |
| **DATABASE_URL** | Railway / `.env` | Для хранения записей AudioFile (категория `gift` и др.). |
| **CLOUDINARY_AUDIO_FOLDER** (опционально) | Railway / `.env` | Если задано и настроен Cloudinary (API key/secret/cloud_name), при пустой БД список аудио подтягивается из этой папки (mp3/m4a и т.д.). |

**Проверка:**  
1) Админ отправляет боту аудиофайл — в ответ «Аудиофайл успешно загружен».  
2) Любой пользователь нажимает «Подарок» → «Слушать звуковые матрицы» — отображаются загруженные файлы или сообщение, как добавить аудио (админ или Cloudinary).

---

## 4. Общие переменные окружения (сводка)

Минимальный набор для работы всех трёх блоков на Railway:

```env
BOT_TOKEN=...                    # от @BotFather
BOT_USERNAME=ИМЯ_БОТА_БЕЗ_@      # точно как в BotFather
DATABASE_URL=mongodb://.../plazma_bot?authSource=admin
ADMIN_CHAT_ID=123456789          # для загрузки аудио и админ-функций
ADMIN_EMAIL=...
ADMIN_PASSWORD=...
PUBLIC_BASE_URL=https://ваш-домен.up.railway.app
```

Опционально:

```env
CLOUDINARY_CLOUD_NAME=...
CLOUDINARY_API_KEY=...
CLOUDINARY_API_SECRET=...
CLOUDINARY_AUDIO_FOLDER=папка/с/аудио   # fallback для звуковых матриц
```

---

## 5. Порядок проверки после деплоя

1. **Реф-ссылка:** «Ваша реф ссылка» → приходит ссылка `t.me/BOT?start=ref_direct_...` → переход по ней и Start → в логах реферал.
2. **Каталог:** «Открыть каталог» / «Каталог по плазменному здоровью» → веб-приложение открывается, видны товары или «Каталог пока пуст».
3. **Аудио:** админ отправляет аудио боту → «Аудиофайл успешно загружен»; пользователь нажимает «Слушать звуковые матрицы» → видит список или подсказку.

Если что-то не работает — смотреть логи сервиса (Railway → Deployments → View Logs): там выводятся ошибки БД, реферала и загрузки аудио.
